#!/bin/sh

# This is a very small download manager for web-browsers such
# as jumanji.
# It provides the ability to either save the file to disk or
# to save it temporary and open it with an application. It
# makes heavy use of dmenu to achieve this.
# In addition it provides cookie and rudimentary certificate
# support.
#
# A file can be opened with an application by selection the
# special file `!open' from dmenu. After that you have to
# choose the application.
#
# An other special file is `!last' which jumps to the last
# directory you have downloaded to.

# The URL and the cookie have to be provided as parameters to
# this script (e.g. by jumanji).
url=$1
cookie=$2

# File to save $last
last_path=$HOME/.download-helper

# CA certificate directory
ca_path="/etc/ssl/certs"

# Get last directory downloaded to
last=$(cat $last_path)

# Include the dmenu config
. $HOME/configs/dmenu_config.sh

# Prompt the user for the filename and propagate the return code
function runDmenu() {
  file=$((echo -e ".\n.."; ls; echo -e "!open\n!last (${last})") | dmenu $dmenu_conf -l 15 -p $PWD)
  return $(test -n "$file")
}

# A simple abstraction from curl
# first parameter: the cookie
# second parameter: the url
# third parameter: the local filename
function runCurl() {
  if [ $# -eq 2 ]; then
    curl -L --capath ${ca_path} --cookie-jar ${1} ${2} -O
  else
    curl -L --capath ${ca_path} --cookie-jar ${1} ${2} -o ${3}
  fi

  # Verification of certificate failed
  if [ $? -eq 60 ]; then
      ans=$(echo -e "Yes\nNo" | dmenu $dmenu_conf -i -p "The verification of the certificate failed. Download without verification?")
      if echo $ans | grep -i "^Yes" > /dev/null ; then
          if [ $# -eq 2 ]; then
              curl -kL --cookie-jar ${1} ${2} -O
          else
              curl -kL --cookie-jar ${1} ${2} -o ${3}
          fi
      fi
  fi

  echo $PWD > $last_path
}

# Run until location is choosen or dmenu exists
while runDmenu; do

  # Changes to last directory
  if [[ $file = "!last"* ]]; then
      cd $last

  # Opens the file directly with an application selected by dmenu
  elif [ $file = "!open" ]; then
      cmd=$(dmenu_path | dmenu $dmenu_conf)
      tempfile=$(mktemp)
      runCurl $cookie $url $tempfile && exec $cmd $tempfile

  # File will be downloaded with original name
  elif [ $file = "." ]; then
      runCurl $cookie $url
      exit

  # Change directory
  elif [ -d $file ]; then
      cd $file

  # Overwrite existing file
  elif [ -f $file ]; then
      ans=$(echo -e "Yes\nNo" | dmenu $dmenu_conf -i -p "Overwrite existing file $file?")
      if echo $ans | grep -i "^Yes" > /dev/null ; then
        runCurl $cookie $url $PWD/$file
      fi
      exit

  # Create new file
  else
      runCurl $cookie $url $PWD/$file
      exit
  fi
done
